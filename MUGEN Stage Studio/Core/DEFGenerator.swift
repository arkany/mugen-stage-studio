import Foundation

/// Generates .def stage definition files for MUGEN/IKEMEN GO
class DEFGenerator {
    
    /// Generate DEF file content from a stage document
    /// - Parameter document: The stage document to export
    /// - Returns: String content of the .def file
    static func generate(from document: StageDocument) -> String {
        var lines: [String] = []
        
        // Header comment
        lines.append("; Generated by MUGEN Stage Studio")
        lines.append("; Compatible with \(document.targetEngine.rawValue)")
        lines.append("")
        
        // [Info] section
        lines.append("[Info]")
        lines.append("name = \"\(document.name)\"")
        lines.append("displayname = \"\(document.name)\"")
        lines.append("mugenversion = \(document.targetEngine.mugenVersion)")
        if document.targetEngine == .ikemenGo {
            lines.append("ikemenversion = 1.0")
        }
        lines.append("author = \"MUGEN Stage Studio\"")
        lines.append("")
        
        // [Camera] section
        lines.append("[Camera]")
        lines.append("startx = 0")
        lines.append("starty = 0")
        lines.append("boundleft = \(document.camera.boundLeft)")
        lines.append("boundright = \(document.camera.boundRight)")
        lines.append("boundhigh = \(document.camera.boundHigh)")
        lines.append("boundlow = 0")
        lines.append("tension = \(document.camera.tension)")
        lines.append("verticalfollow = \(String(format: "%.1f", document.camera.verticalFollow))")
        lines.append("floortension = \(document.camera.floorTension)")
        
        // Zoom settings (MUGEN 1.1+ / IKEMEN only)
        if document.targetEngine.supportsZoom && document.camera.zoomEnabled {
            lines.append("startzoom = \(String(format: "%.2f", document.camera.zoomStart))")
            lines.append("zoomin = \(String(format: "%.2f", document.camera.zoomMax))")
            lines.append("zoomout = \(String(format: "%.2f", document.camera.zoomMin))")
        }
        lines.append("")
        
        // [PlayerInfo] section
        let imageWidth = document.imageSize?.width ?? 1280
        let leftbound = Int(-imageWidth / 2) + 50
        let rightbound = Int(imageWidth / 2) - 50
        
        lines.append("[PlayerInfo]")
        lines.append("p1startx = \(document.players.p1X)")
        lines.append("p1starty = 0")
        lines.append("p1facing = \(document.players.p1Facing)")
        lines.append("p2startx = \(document.players.p2X)")
        lines.append("p2starty = 0")
        lines.append("p2facing = \(document.players.p2Facing)")
        lines.append("leftbound = \(leftbound)")
        lines.append("rightbound = \(rightbound)")
        lines.append("")
        
        // [Bound] section
        lines.append("[Bound]")
        lines.append("screenleft = 15")
        lines.append("screenright = 15")
        lines.append("")
        
        // [StageInfo] section
        lines.append("[StageInfo]")
        lines.append("zoffset = \(document.groundLineY)")
        lines.append("autoturn = 1")
        lines.append("resetBG = 1")
        lines.append("localcoord = \(document.resolution.width), \(document.resolution.height)")
        lines.append("portraitscale = 1")  // Thumbnail scale for stage select
        lines.append("")
        
        // [Shadow] section
        if document.shadow.enabled {
            lines.append("[Shadow]")
            lines.append("intensity = \(document.shadow.intensity)")
            lines.append("yscale = \(String(format: "%.1f", document.shadow.yscale))")
            lines.append("")
        }
        
        // [Reflection] section (optional, default off)
        lines.append("[Reflection]")
        lines.append("reflect = 0")
        lines.append("")
        
        // [BGDef] section
        lines.append("[BGDef]")
        lines.append("spr = stages/\(document.safeName)/\(document.safeName).sff")
        lines.append("debugbg = 0")
        lines.append("")
        
        // Background layers
        for (index, layer) in document.layers.enumerated() where layer.visible {
            lines.append("[BG \(index)]")
            lines.append("type = normal")
            lines.append("spriteno = 0, \(index)")
            lines.append("start = \(Int(layer.position.x)), \(Int(layer.position.y))")
            lines.append("delta = \(String(format: "%.1f", layer.delta.x)), \(String(format: "%.1f", layer.delta.y))")
            lines.append("tile = \(layer.tiling.defValue)")
            lines.append("layerno = \(layer.layerIndex)")
            lines.append("mask = 0")
            lines.append("")
        }
        
        // Stage select thumbnail action
        lines.append("; Stage select thumbnail")
        lines.append("[Begin Action 9000]")
        lines.append("9000,1, 0,0, -1")
        
        return lines.joined(separator: "\n")
    }
}
